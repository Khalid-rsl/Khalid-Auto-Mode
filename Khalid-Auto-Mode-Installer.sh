#!/bin/bash
# Developed by Khalid Rasul (Khalid_RSL)
# âš–ï¸ License: MIT License - Personal & Non-Commercial Use [cite: 1]
# âš–ï¸ License: This project is licensed under the MIT License - see the LICENSE file for details. 

# ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø£Ù„ÙˆØ§Ù† (Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ)
G='\033[0;32m' # Ø§Ù„Ø£Ø®Ø¶Ø±
B='\033[0;34m' # Ø§Ù„Ø£Ø²Ø±Ù‚
Y='\033[1;33m' # Ø§Ù„Ø£ØµÙØ±
C='\033[0;36m' # Ø§Ù„Ø³Ù…Ø§ÙˆÙŠ
NC='\033[0m'    # Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠ

clear

# ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ø±ØªØ¨Ø© Ù…Ø¹ ØªÙˆØ«ÙŠÙ‚ Ø§Ù„ØªØ±Ø®ÙŠØµ Ø§Ù„ÙƒØ§Ù…Ù„
echo -e "${B}############################################################${NC}"
echo -e "${B}#${NC}                                                          ${B}#${NC}"
echo -e "${B}#${NC}    ${C}â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•—â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•—     â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— ${NC}        ${B}#${NC}"
echo -e "${B}#${NC}    ${C}â–ˆâ–ˆâ•‘ â–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—${NC}        ${B}#${NC}"
echo -e "${B}#${NC}    ${C}â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â• â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘${NC}        ${B}#${NC}"
echo -e "${B}#${NC}    ${C}â–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•— â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘${NC}        ${B}#${NC}"
echo -e "${B}#${NC}    ${C}â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•${NC}        ${B}#${NC}"
echo -e "${B}#${NC}    ${C}â•šâ•â•  â•šâ•â•â•šâ•â•  â•šâ•â•â•šâ•â•  â•šâ•â•â•šâ•â•â•â•â•â•â•â•šâ•â•â•šâ•â•â•â•â•â• ${NC}        ${B}#${NC}"
echo -e "${B}#${NC}                                                          ${B}#${NC}"
echo -e "${B}#${NC}  ${Y}        >>> KHALID - AUTO - MODE (RSL) <<<      ${NC}        ${B}#${NC}"
echo -e "${B}#${NC}  ${G}    License: MIT - Personal & Non-Commercial Use    ${NC}    ${B}#${NC}"
echo -e "${B}#${NC}  ${C}    See LICENSE file for full legal details         ${NC}    ${B}#${NC}"
echo -e "${B}############################################################${NC}"
echo -e "${G}  [+] Status: System Check... [Ø¬Ø§Ø±ÙŠ ÙØ­Øµ Ø§Ù„Ù†Ø¸Ø§Ù…]${NC}"
echo -e "  [+] Developer: Khalid_RSL | ðŸ¦… High-Vision Tools"
echo -e "${B}------------------------------------------------------------${NC}"

# 1. Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ù„ÙØ§Øª [cite: 6]
echo -e "${C}[1/5]${NC} Preparing files... [Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ù„ÙØ§Øª]"
sudo cp /etc/X11/xorg.conf /etc/X11/xorg.conf.custom 2>/dev/null
sudo touch /etc/X11/xorg.conf.empty

# 2. Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø³ÙƒØ±Ø¨Øª Ø§Ù„Ø°ÙƒÙŠ [cite: 5]
echo -e "${C}[2/5]${NC} Creating Smart Switcher... [Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø³ÙƒØ±Ø¨Øª Ø§Ù„Ø°ÙƒÙŠ]"
sudo tee /usr/local/bin/graphics-switcher > /dev/null <<EOF
#!/bin/bash
if lspci | grep -Ei 'nvidia|vga|graphics' | grep -v 'Intel' > /dev/null; then
    ln -sf /etc/X11/xorg.conf.custom /etc/X11/xorg.conf
else
    ln -sf /etc/X11/xorg.conf.empty /etc/X11/xorg.conf
fi
EOF
sudo chmod +x /usr/local/bin/graphics-switcher

# 3. Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù… [cite: 2, 3]
echo -e "${C}[3/5]${NC} Fetching System UUID & Kernel... [Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª]"
LATEST_VMLINUZ=\$(ls -v /boot/vmlinuz-* | tail -n 1 | xargs basename)
LATEST_INITRD=\$(ls -v /boot/initrd.img-* | tail -n 1 | xargs basename)
CURRENT_UUID=\$(grub-probe --target=fs_uuid /)

# 4. Ø¨Ù†Ø§Ø¡ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø±Ø§Ø¨ [cite: 1, 4]
echo -e "${C}[4/5]${NC} Configuring GRUB Menu... [Ø¥Ø¹Ø¯Ø§Ø¯ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¥Ù‚Ù„Ø§Ø¹]"
sudo tee /etc/grub.d/40_custom > /dev/null <<EOF
#!/bin/sh
exec tail -n +3 \$0
menuentry 'KALI - Auto Mode (Khalid_RSL)' {
    search --no-floppy --fs-uuid --set=root $CURRENT_UUID
    linux /boot/$LATEST_VMLINUZ root=UUID=$CURRENT_UUID ro quiet splash khalid_mode
    initrd /boot/$LATEST_INITRD
}
EOF

# 5. Ø§Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ [cite: 4, 7]
echo -e "${C}[5/5]${NC} Finalizing... [ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Ø¸Ø§Ù…]"
(crontab -l 2>/dev/null | grep -v "graphics-switcher"; echo "@reboot /usr/local/bin/graphics-switcher") | sudo crontab -
sudo update-grub > /dev/null 2>&1
sudo update-initramfs -u -k all > /dev/null 2>&1

echo -e "${B}------------------------------------------------------------${NC}"
echo -e "${G}SUCCESS: KHALID-AUTO-MODE is now installed!${NC}"
echo -e "${Y}Please reboot and select the new entry from GRUB.${NC}"
echo -e "${B}############################################################${NC}"
